type: flashlight
parts:
  switch:
    attributes:
      position:
        space: binary_state
        default: 'off'
        mutable: true
  bulb:
    attributes:
      state:
        space: binary_state
        default: 'off'
        mutable: true
      brightness:
        space: brightness_level
        default: none
  battery:
    attributes:
      level:
        space: battery_level
        default: unknown
        mutable: true
      type:
        space: battery_types
        mutable: false
        default: AA

constraints:
- type: dependency
  condition:
    type: attribute_check
    target: bulb.state
    operator: equals
    value: on
  requires:
    type: attribute_check
    target: battery.level
    operator: not_equals
    value: empty

behaviors:
  turn_on:
    preconditions:
      - type: attribute_check
        target: switch.position
        operator: equals
        value: off
      - type: attribute_check
        target: battery.level
        operator: not_equals
        value: empty
    effects:
      - type: set_attribute
        target: switch.position
        value: "on"
      - type: set_attribute
        target: bulb.state
        value: "on"
      - type: conditional
        condition:
          type: attribute_check
          target: battery.level
          operator: equals
          value: high
        then:
          - type: set_attribute
            target: bulb.brightness
            value: high
        else:
          - type: conditional
            condition:
              type: attribute_check
              target: battery.level
              operator: equals
              value: medium
            then:
              - type: set_attribute
                target: bulb.brightness
                value: medium
            else:
              - type: set_attribute
                target: bulb.brightness
                value: low
      - type: set_trend
        target: battery.level
        direction: down
  turn_off:
    preconditions:
      - type: attribute_check
        target: switch.position
        operator: equals
        value: on
    effects:
      - type: set_attribute
        target: switch.position
        value: off
      - type: set_attribute
        target: bulb.state
        value: off
      - type: set_attribute
        target: bulb.brightness
        value: none
      - type: set_trend
        target: battery.level
        direction: none
